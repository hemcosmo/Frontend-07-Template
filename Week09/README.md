## html 解析

- html 标签种类

1. 开始标签
1. 结束标签
1. 自封闭标签

- 实现 html parser

1. 为了方便文件管理, 把 parser 拆分到单独的文件中
1. parser 接收 html 作为参数, 返回 dom 树
1. 利用有限状态机来实现 html 的分析
1. html 标准中规定了状态(tokenize)
1. 状态机中除了状态迁移, 还需要加入业务逻辑(创建 token, 把字符加入, 最后 emit)
1. 标签结束状态提交标签 token
1. 属性分成三种写法
1. 处理方式和标签类似
1. 属性结束时, 把属性加到标签 token 上
1. 使用栈从标签构建 dom 树
1. 遇到开始标签时创建元素并且入栈, 遇到结束标签时出栈
1. 自封闭节点可视为入栈后立即出栈
1. 任何元素的父元素都是入栈前的栈顶元素
1. 文本节点和自封闭标签处理类似
1. 多个文本节点需要合并

- css specificity

1. 四元组 [inline, id, class, tag] = [0, 0, 0, 0]
1. 比较时从高位比较, 相等时再向下比较

- 实现 css computing

1. 遇到 style 标签时就把 css 规则保存起来
1. 调用 css parser 来分析 css 规则
1. 创建一个元素后立刻计算 css
1. 分析一个元素时所有的 css 已经收集完毕
1. 真实浏览器中, 可能遇到写在 body 的 style 标签, 需要重新 css 计算的情况
1. 知道所有的父元素才能判断元素与规则是否匹配
1. 从上一步骤的 stack 获取本元素所有的父元素
1. 首先获取的是当前元素, 所以获得和计算父元素匹配的顺序是从内而外
1. 选择器也从当前元素向外排列
1. 复杂选择器拆成针对单个元素的选择器, 用循环匹配父元素队列
1. 根据选择器的类型和元素属性, 计算是否与当前元素匹配
1. 一旦选择匹配, 就应用选择器到元素上, 形成 computedStyle
1. css 规则根据 specificity 和后来优先规则覆盖
1. specificity 是四元组, 越左边权限越高
1. 一个 css 规则的 specificity 根据包含的简单选择器相加而成
